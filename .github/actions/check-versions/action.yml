name: 'Check Version Consistency'
description: 'Verify VERSION file matches pyproject.toml and package.json versions'

runs:
  using: 'composite'
  steps:
    - name: Check version consistency
      shell: bash
      run: |
        set -euo pipefail

        # Read canonical version from VERSION file
        if [ ! -f "VERSION" ]; then
          echo "ERROR: VERSION file not found"
          exit 1
        fi
        VERSION_FILE=$(tr -d '[:space:]' < VERSION)
        if [ -z "$VERSION_FILE" ]; then
          echo "ERROR: VERSION file is empty"
          exit 1
        fi
        echo "VERSION file:           $VERSION_FILE"

        # Check backend/pyproject.toml exists
        if [ ! -f "backend/pyproject.toml" ]; then
          echo "ERROR: backend/pyproject.toml not found"
          exit 1
        fi

        # Extract version from backend/pyproject.toml
        PYPROJECT_VERSION=$(grep -m1 '^version = "' backend/pyproject.toml | sed 's/version = "\([^"]*\)".*/\1/' || true)
        if [ -z "$PYPROJECT_VERSION" ]; then
          echo "ERROR: Could not extract version from backend/pyproject.toml"
          exit 1
        fi
        echo "backend/pyproject.toml: $PYPROJECT_VERSION"

        # Check frontend/package.json exists
        if [ ! -f "frontend/package.json" ]; then
          echo "ERROR: frontend/package.json not found"
          exit 1
        fi

        # Extract version from frontend/package.json
        PACKAGE_VERSION=$(grep -m1 '"version"' frontend/package.json | sed 's/.*"version"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' || true)
        if [ -z "$PACKAGE_VERSION" ]; then
          echo "ERROR: Could not extract version from frontend/package.json"
          exit 1
        fi
        echo "frontend/package.json:  $PACKAGE_VERSION"

        # Compare
        FAILED=0

        if [ "$VERSION_FILE" != "$PYPROJECT_VERSION" ]; then
          echo ""
          echo "Version mismatch: VERSION ($VERSION_FILE) != backend/pyproject.toml ($PYPROJECT_VERSION)"
          FAILED=1
        fi

        if [ "$VERSION_FILE" != "$PACKAGE_VERSION" ]; then
          echo ""
          echo "Version mismatch: VERSION ($VERSION_FILE) != frontend/package.json ($PACKAGE_VERSION)"
          FAILED=1
        fi

        if [ $FAILED -eq 1 ]; then
          echo ""
          echo "Use './run bumpversion [patch|minor|major]' to update versions consistently."
          exit 1
        fi

        echo ""
        echo "Version check passed: $VERSION_FILE"
